## Python ESAPI and FAPI examples


Ref: 

* [https://tpm2-pytss.readthedocs.io/en/latest/api.html](https://tpm2-pytss.readthedocs.io/en/latest/api.html)
* [/P_RSA2048SHA256.json](https://github.com/tpm2-software/tpm2-tss/blob/master/dist/fapi-profiles/P_RSA2048SHA256.json)
* [fapi-config](https://github.com/tpm2-software/tpm2-tss/blob/master/doc/fapi-config.md)

* [TSS_FAPI_v0p94_r09_pub.pdf](https://trustedcomputinggroup.org/wp-content/uploads/TSS_FAPI_v0p94_r09_pub.pdf)
* [TSS_JSON_Policy_v0p7_r08_pub](https://trustedcomputinggroup.org/wp-content/uploads/TSS_JSON_Policy_v0p7_r08_pub.pdf)

#### Install

```bash
apt-get install libtss2-dev
python3 -m pip install tpm2-pytss
# python3 -m pip install git+https://github.com/tpm2-software/tpm2-pytss.git
```


### ESAPI

- `esapi_create_sign.py`: create rsa key and sign/verify
- `esapi_encrypt_decrypt.py`: create aes key and encrypt/decrypt
- `esapi_hmac_import.py`: import and use an hmac key
- `esapi_keyfile.py`: create and use PEM encoded keyfiles
- `esapi_auth.py`: create key with auth password
- `esapi_pcr.py`: create key with pcrpolicy
- `esapi_session_encryption_auth.py`:  encrypted sessions with password AES
- `esapi_session_encryption_pcr.py`: encrypted sessions with pcr policy AES
- `esapi_session_encryption_authvalue_pcr_aes.py`:  encrypted sessions with pcr and authvalue AES
- `esapi_session_encryption_authvalue_pcr_rsa.py`:  encrypted sessions with pcr and authvalue RSA
- `esapi_tpm2.py`: load key created using tpm2_tools

- `fapi_create_sign.py`: create rsa key and sign/verify
- `fapi_seal_unseal.py`: seal/unseal 
- `fapi_import_tpm2.py`: import pub/priv keys generated by tpm2tools into fapi contexts
- `fapi_export_tpm2.py`: export key fapi context to pub/priv blobs readable by tpm2tools
- `fapi_auth.py`: create key and bind to password auth with callback
- `fapi_pcr.py`: create key and bind to pcr policy

### Policy JSON

[JSON Data Types and Policy Language Specification](https://trustedcomputinggroup.org/resource/tcg-tss-json/)


### ESAPI Session Encryption

From : [TCG_CPU_TPM_Bus_Protection_Guidance_Passive_Attack_Mitigation](https://trustedcomputinggroup.org/wp-content/uploads/TCG_CPU_TPM_Bus_Protection_Guidance_Passive_Attack_Mitigation_8May23-3.pdf)

```
â€¢ Application developers typically use the high-level TCG Feature API (FAPI) [3]. A compliant TSS
implementation of FAPI automatically encrypts commands and responses, and no work is required by
application developers.
```


```bash
rm -rf ~/.local/share/tpm2-tss/
rm -rf /tmp/myvtpm && mkdir /tmp/myvtpm
sudo swtpm_setup --tpmstate /tmp/myvtpm --tpm2 --create-ek-cert 
sudo swtpm socket --tpmstate dir=/tmp/myvtpm --tpm2 --server type=tcp,port=2321 --ctrl type=tcp,port=2322 --flags not-need-init,startup-clear  --log level=5

export TPM2TOOLS_TCTI="swtpm:port=2321"
export TPM2OPENSSL_TCTI="swtpm:port=2321"

tpm2_flushcontext -t && tpm2_flushcontext -s && tpm2_flushcontext -l
```


#### Policy AuthValue and DuplicateSelect

initialize and AES key with Password using [tpmcopy](https://github.com/salrashid123/tpmcopy/tree/main?tab=readme-ov-file#aes)

```json
{
    "description": "Policy OR",
    "policyDigests": [
        {
            "hashAlg": "sha256",
            "digest": "117561e1e6fb636da557977c52c0f9424dcd96f175d12e2ddb8f588c84e63ab8"
        }
    ],
    "policy": [
        {
            "type": "POLICYOR",
            "policyDigests": [
                {
                    "hashAlg": "sha256",
                    "digest": "117561e1e6fb636da557977c52c0f9424dcd96f175d12e2ddb8f588c84e63ab8"
                }
            ],
            "branches": [
                {
                    "name": "authvalue",
                    "description": "Policy AuthValue",
                    "policy": [
                        {
                            "type": "POLICYAUTHVALUE",
                            "policyDigests": [
                                {
                                    "hashAlg": "sha256",
                                    "digest": "8fcd2169ab92694e0c633f1ab772842b8241bbc20288981fc7ac1eddc1fddb0e"
                                }
                            ]
                        }
                    ],
                    "policyDigests": [
                        {
                            "hashAlg": "sha256",
                            "digest": "8fcd2169ab92694e0c633f1ab772842b8241bbc20288981fc7ac1eddc1fddb0e"
                        }
                    ]
                },
                {
                    "name": "duplicationSelect",
                    "description": "Policy DuplicateSelect",
                    "policy": [
                        {
                            "type": "POLICYDUPLICATIONSELECT",
                            "policyDigests": [
                                {
                                    "hashAlg": "sha256",
                                    "digest": "e0f9c898e43bb6d60c7a9f7c24e1641e11fd1092fc6c0a032c587cb78aa61e71"
                                }
                            ],
                            "objectName": "",
                            "newParentName": "000bff03fd26a7d1c1164964b6fd790cf7db7f6177c2034bfb4a2aaef8f3b13792f6",
                            "includeObject": "NO"
                        }
                    ],
                    "policyDigests": [
                        {
                            "hashAlg": "sha256",
                            "digest": "e0f9c898e43bb6d60c7a9f7c24e1641e11fd1092fc6c0a032c587cb78aa61e71"
                        }
                    ]
                }
            ]
        }
    ]
}
```

#### Policy PCR and DuplicateSelect

initialize and AES key with PCR Policy using [tpmcopy](https://github.com/salrashid123/tpmcopy/tree/main)


```json
{
    "description": "Policy OR",
    "policyDigests": [
        {
            "hashAlg": "sha256",
            "digest": "ecc7a235ba2a4e2ffb2e30cadae639bb3fab82b9231ea88b3bde38764677554e"
        }
    ],
    "policy": [
        {
            "type": "POLICYOR",
            "policyDigests": [
                {
                    "hashAlg": "sha256",
                    "digest": "ecc7a235ba2a4e2ffb2e30cadae639bb3fab82b9231ea88b3bde38764677554e"
                }
            ],
            "branches": [
                {
                    "name": "pcrPolicy",
                    "description": "Policy PCR",
                    "policy": [
                        {
                            "type": "POLICYPCR",
                            "policyDigests": [
                                {
                                    "hashAlg": "sha256",
                                    "digest": "2094289099c2cb180f28f99c71c8d681123935f7330bdae5aa1ae1e09f0fe532"
                                }
                            ],
                            "pcrs": [
                                {
                                    "pcr": 23,
                                    "hashAlg": "sha256",
                                    "digest": "f5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b"
                                }
                            ]
                        }
                    ],
                    "policyDigests": [
                        {
                            "hashAlg": "sha256",
                            "digest": "2094289099c2cb180f28f99c71c8d681123935f7330bdae5aa1ae1e09f0fe532"
                        }
                    ]
                },
                {
                    "name": "duplicationSelect",
                    "description": "Policy DuplicateSelect",
                    "policy": [
                        {
                            "type": "POLICYDUPLICATIONSELECT",
                            "policyDigests": [
                                {
                                    "hashAlg": "sha256",
                                    "digest": "e0f9c898e43bb6d60c7a9f7c24e1641e11fd1092fc6c0a032c587cb78aa61e71"
                                }
                            ],
                            "objectName": "",
                            "newParentName": "000bff03fd26a7d1c1164964b6fd790cf7db7f6177c2034bfb4a2aaef8f3b13792f6",
                            "includeObject": "NO"
                        }
                    ],
                    "policyDigests": [
                        {
                            "hashAlg": "sha256",
                            "digest": "e0f9c898e43bb6d60c7a9f7c24e1641e11fd1092fc6c0a032c587cb78aa61e71"
                        }
                    ]
                }
            ]
        }
    ]
}
```